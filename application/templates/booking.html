{% extends 'base.html' %}
{% load bnb_info_filter %} {# Load webfilter sử dụng #}

{% load static %}

{% block title %}
    <title>Đặt phòng - VietHomeAir</title>
{% endblock title %}


{% block header_scripts %}
    {#  Thư viện momentjs để dùng daterangepickerjs  #}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    {#  Thư viện daterangepickerjs  #}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.4/marked.min.js"
            integrity="sha512-VmLxPVdDGeR+F0DzUHVqzHwaR4ZSSh1g/7aYXwKT1PAGVxunOEcysta+4H5Utvmpr2xExEPybZ8q+iM9F1tGdw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
{% endblock header_scripts %}

{% block stylesheet %}
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
    <link rel="stylesheet" href="{% static 'style/leaflet-osm.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .booking-header {
            text-align: center;
            padding: 2rem 0;
        }

        .booking-header h1 {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .booking-header p {
            color: #6c757d;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .product-card img {
            width: 100%;
            border-radius: 10px;
            height: auto;
            object-fit: cover;
        }

        .product-card h5 {
            color: #5874a5;
            font-weight: bold;
            margin-top: 10px;
        }

        .product-card p {
            margin-bottom: 0.5rem;
            color: #6c757d;
        }
    </style>
{% endblock stylesheet %}

{% block content %}
    <div class="container mt-5">
        <!-- Header -->
        <div class="booking-header">
            <h1>Đặt phòng dễ dàng với VietHomeAir</h1>
            <p>Khám phá các căn hộ và phòng nghỉ lý tưởng cho chuyến đi của bạn!</p>
        </div>

        <!-- Hien thi lo -->
        {% if error %}
        	<div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}


        <div class="row g-4">
            <!-- Form bên trái -->
            <div class="product-card col-lg-6">
                <div class="custom-form">
                    <h4 class="fw-bold mb-3">Đặt phòng</h4>
                    <form method="get" action="">
                        {% csrf_token %}
                       
                        <!-- Ngày nhận và trả phòng -->
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <label for="checkin_date" class="form-label">Ngày nhận phòng <span class="required" style="color: red">*</span></label>
                                <input type="date" class="form-control" id="checkin_date" name="checkin_date" required>
                            </div>
                            <div class="col">
                                <label for="checkout_date" class="form-label">Ngày trả phòng <span class="required" style="color: red">*</span></label>
                                <input type="date" class="form-control" id="checkout_date" name="checkout_date" required>
                            </div>
                        </div>
                        <!-- Số người -->
                        <div class="mb-3">
                                <label for="capacity" class="form-label" >Số người<span class="required" style="color: red">*</span></label>
                                <input type="number" class="form-control" id="capacity" name="capacity" required>
                        </div>

                         <!-- CCCD -->
                        <div class="mb-3">
                            <label for="validate" class="form-label">CCCD<span class="required" style="color: red">*</span></label>
                            <input type="text" class="form-control" id="cccd" name="cccd" placeholder="Nhập CCCD..." required>
                        </div>

                        <!-- ghi chú  -->
                        <div class="row g-2 mb-3">
                            <label for="note" class="form-label">Ghi chú </label>
                            <textarea style="resize: none" name="" id="" cols="30" rows="10" placeholder="Bạn muốn thêm điều gì thú vị cho căn phòng..."></textarea>
                        </div>
                        
                        

                        <!-- Nút đặt phòng -->
                        <div class="d-grid">
                            <button class="btn btn-primary">Đặt phòng</button>
                        </div>


                    </form>
                </div>
</div>


            <!-- Danh sách sản phẩm bên phải -->
            <div class="col-lg-6">
                    <div class="row">
                        <!-- Sản phẩm 1 -->
                        <div class="col-md-12">
                            <div class="product-card">
                                <img src="{{ bnb.image }}" alt="Phòng nghỉ hiện đại" class="img-fluid">
                                <h5>{{ bnb.name }}</h5>
                                <p><strong>{{ bnb.price|floatformat:0 }} đ/ đêm</strong></p>

                                <!-- Thông tin chủ nhà -->
                                <div class="host-info mt-4">
                                    <h6><strong>Chủ nhà: {{ owner_name }}</strong></h6>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <img src="{{ owner_avatar }}" alt="Chủ nhà" class="img-fluid rounded-circle">
                                        </div>
                                        <div class="col-md-10">
                                            <p><strong>{{ owner_name }}:</strong><br> Chủ nhà siêu cấp là những người có kinh nghiệm, được đánh giá cao và cam kết mang lại kỳ nghỉ tuyệt vời cho khách.</p>
                                        </div>
                                    </div>
                                    <div class="border-bottom my-3"></div>

                                    <!-- Tổng tiền -->
                                    <div class="d-grid mt-3 d-flex">
                                        <p class="text-left">Tổng tiền: <p id="total_price" class="fw-bold">0</p> ₫</p>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Các sản phẩm còn lại sẽ có cấu trúc tương tự -->
                    </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Disable các ngày đã qua
        const today = new Date().toISOString().split('T')[0];
        const checkinDateInput = document.getElementById('checkin_date');
        const checkoutDateInput = document.getElementById('checkout_date');
        const capacityInput = document.getElementById('capacity');
        const cccdInput = document.getElementById('cccd');

        checkinDateInput.setAttribute('min', today);
        checkoutDateInput.setAttribute('min', today);

        // Lấy giá từ context
        const pricePerNight = parseFloat("{{ bnb.price }}"); // Giá từ server

        function calculateTotal() {
            const checkinDate = new Date(checkinDateInput.value);
            const checkoutDate = new Date(checkoutDateInput.value);

            // Kiểm tra nếu cả hai ngày đã được chọn
            if (checkinDateInput.value && checkoutDateInput.value) {
                // Tính số ngày
                const diffTime = checkoutDate - checkinDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // Nếu ngày trả phòng nhỏ hơn ngày nhận phòng, đặt giá trị mặc định
                if (diffDays <= 0) {
                    alert('Ngày trả phòng phải lớn hơn ngày nhận phòng.');
                    checkoutDateInput.value = '';
                    return;
                }

                // Tính tổng tiền
                const totalPrice = diffDays * pricePerNight;

                // Hiển thị tổng tiền
                document.getElementById('total_price').textContent = `${totalPrice.toLocaleString()}`;
            } else {
                document.getElementById('total_price').textContent = '0';
            }
        }

        // Lắng nghe sự kiện thay đổi
        checkinDateInput.addEventListener('change', calculateTotal);
        checkoutDateInput.addEventListener('change', calculateTotal);

        // Gán các giá trị vào form từ URL nếu có
        const urlParams = new URLSearchParams(window.location.search);
        const checkin = urlParams.get('checkin');
        const checkout = urlParams.get('checkout');
        const capacity = urlParams.get('capacity');
        const cccd = urlParams.get('cccd'); // Nếu bạn muốn lấy CCCD từ URL

        if (checkin) checkinDateInput.value = checkin;
        if (checkout) checkoutDateInput.value = checkout;
        if (capacity) capacityInput.value = capacity;
        if (cccd) cccdInput.value = cccd;

        // Tính tổng tiền nếu đã có giá trị checkin/checkout từ URL
        calculateTotal();
    });
</script>
     {{ bnb.booking|json_script:'booking-data' }}
    <script>
        // Wishlist button logic
        $("#wishlist-btn").click(function () {
            {% save_bnb_to_wishlists request.session bnb.id as wishlist %}
        });
    </script>
    <script src="{% static 'scripts/product.js' %}"></script>
    <script type="module">
        const listAvailableRange = JSON.parse($("#booking-data").text());
        const defaultRange = listAvailableRange[0];

        // Set placeholders for the date fields
        $("#checkin-date").attr("placeholder", defaultRange.check_in);
        $("#checkout-date").attr("placeholder", defaultRange.check_out);
        $("#booking-length").text(defaultRange.range_length);

        // Helper to check if a date is in valid ranges
        function isInValidRanges(date) {
            return !listAvailableRange.some(range => {
                const start = moment(range.check_in);
                const end = moment(range.check_out);
                return date.isBetween(start, end, null, '[]');
            });
        }

        $(function () {
            // Initialize date pickers
            $('#checkin-date, #checkout-date').daterangepicker({
                startDate: moment(listAvailableRange[0].check_in),
                endDate: moment(listAvailableRange[0].check_out),
                minDate: moment().startOf('day'),
                opens: 'left',
                autoUpdateInput: false,
                locale: {
                    format: 'YYYY-MM-DD',
                },
                isInvalidDate: function (date) {
                    return isInValidRanges(date);
                }
            });

            // Apply logic for check-in and check-out date changes
            $('#checkin-date').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('YYYY-MM-DD'));
                $('#checkout-date').val(picker.endDate.format('YYYY-MM-DD'));
                recalculatePrice($("#bnb-base-price").text(), picker.endDate.diff(picker.startDate, "days") + 1);
            });

            $('#checkout-date').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.endDate.format('YYYY-MM-DD'));
                $('#checkin-date').val(picker.startDate.format('YYYY-MM-DD'));
                recalculatePrice($("#bnb-base-price").text(), picker.endDate.diff(picker.startDate, "days") + 1);
            });
        });

        // Recalculate price based on date range
        function recalculatePrice(priceStr, dateDiff) {
            const basePrice = parseInt(priceStr.trim().replaceAll("VNĐ", "").replaceAll(".", ""));
            const bookingPrice = basePrice * dateDiff;
            const totalPrice = bookingPrice + 70000; // Fixed service fee of 70,000 VNĐ
            $("#booking-length").text(dateDiff);
            $("#bnb-price").text(modifyPriceValue(bookingPrice));
            $("#bnb-total-price").text(modifyPriceValue(totalPrice));
        }

        // Format price for display
        function modifyPriceValue(price) {
            return price.toLocaleString("vi-VN") + " VNĐ";
        }
    </script>
    <script type="module">
        $(document).ready(() => {
            // Display Markdown content
            $("#description-display").html(marked.parse(`{{ bnb.description|escapejs }}`));
            $("#service-bnb").html(marked.parse(`{{ bnb.services|escapejs }}`));
            $("#owner-description").html(marked.parse(`{{ bnb.owner.description|escapejs }}`));

            // Show or hide comment form based on review status
            {% user_review_status request.session bnb.id as review_status %}
            {% if review_status %}
                $("#upload-comment-form").removeClass('d-none');
                $("#upload-comment-form button").attr("disabled", false);
            {% else %}
                $("#upload-comment-form").addClass('d-none');
                $("#upload-comment-form button").attr("disabled", true);
            {% endif %}
        });

        // Filter reviews based on sentiment
        function filterReview(sentimentType) {
            let filterLabel = "";
            switch (sentimentType) {
                case "positive":
                    filterLabel = "Tích cực";
                    break;
                case "negative":
                    filterLabel = "Tiêu cực";
                    break;
                default:
                    filterLabel = "";
            }

            $.ajax({
                url: '{{ request.path }}',
                method: 'GET',
                data: {
                    'sentiment_type': sentimentType
                },
                success: function (response) {
                    let reviewContents = '';
                    if (sentimentType !== "all") {
                        $("#filter-text").removeClass("d-none");
                        $("#filter-label").text(filterLabel);
                    } else {
                        $("#filter-text").addClass("d-none");
                    }
                    $.each(response.reviews, function (index, review) {
                        reviewContents += `
                            <div class="col-6 comment-component">
                                <div class="rounded-4 row p-1">
                                    <div class="col-2 d-flex flex-column justify-content-center">
                                        <img class="text-center display-4 rounded-circle"
                                             src="${review.avatar}"
                                             alt="" width="80px" height="80px">
                                    </div>
                                    <div class="col d-flex align-items-center">
                                        <p style="font-size: 18px"
                                           class="fw-semibold m-0">${review.fullname}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    ${review.rating_content}
                                </div>
                                <div class="row comment-component__content my-2">
                                    <p>${review.content}</p>
                                </div>
                            </div>`;
                    });
                    $('#review-display').html(reviewContents);
                }
            });
        }

        $("#filter-positive-review").click(() => filterReview('positive'));
        $("#filter-negative-review").click(() => filterReview('negative'));
        $("#unfilter-review").click(() => filterReview('all'));

        // Booking button logic
        $("#booking-btn").click(() => {
            const checkinDate = $("#checkin-date").val() || $('#checkin-date').attr('placeholder');
            const checkoutDate = $("#checkout-date").val() || $('#checkout-date').attr('placeholder');
            window.location = `/book?bnbid={{ bnb.id }}&checkin=${checkinDate.trim()}&checkout=${checkoutDate.trim()}&capacity=${$('#booking-capacity').val()}`;
        });
    </script>
{% endblock scripts %}





